<div class="grid">
    <div class="col-12">
        <div class="card px-6 py-6">
            <p-toast></p-toast>
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <div class="my-2">
                        <button pButton pRipple label="Nuevo usuario" icon="pi pi-plus" class="p-button-success mr-2" (click)="openNew()"></button>
                    </div>
                </ng-template>
            </p-toolbar>

            <p-table #dt [value]="listaUsuarios" [columns]="cols" responsiveLayout="scroll" [rows]="10" [globalFilterFields]="['ci', 'nombres','apellidos','email', 'rol.nombre']" [paginator]="true" [rowsPerPageOptions]="[10,20,30]" [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} registros" [(selection)]="selectedProducts" selectionMode="multiple" [rowHover]="true" dataKey="id">
                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Lista de usuarios</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..."  class="w-full sm:w-auto"/>
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="ci">Cédula de identidad<p-sortIcon field="ci"></p-sortIcon></th>
                        <th pSortableColumn="nombres">Nombres<p-sortIcon field="nombres"></p-sortIcon></th>
                        <th pSortableColumn="apellidos">Apellidos<p-sortIcon field="apellidos"></p-sortIcon></th>
                        <th pSortableColumn="email">Email<p-sortIcon field="email"></p-sortIcon></th>
                        <th pSortableColumn="id_rol">Rol<p-sortIcon field="id_rol"></p-sortIcon></th>
                        <th pSortableColumn="created_at">Fecha de registro<p-sortIcon field="created_at"></p-sortIcon></th>
                        <th pSortableColumn="estado_logico">Estado<p-sortIcon field="estado_logico"></p-sortIcon></th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-usuario>
                    <tr>
                        <td>
                            {{ usuario.ci }}
                        </td>
                        <td>
                            {{ usuario.nombres }}
                        </td>
                        <td>
                            {{ usuario.apellidos }}
                        </td>
                        <td>
                            {{ usuario.email }}
                        </td>
                        <td>
                            {{ usuario.rol.nombre }}
                        </td>
                        <td>
                            {{ usuario.created_at | date:'dd/MM/yyyy' }}
                        </td>
                        <td>
                            <p-tag [rounded]="true" [value]="usuario.estado_logico ? 'ACTIVO' : 'INACTIVO'" [severity]="usuario.estado_logico ? 'success' : 'danger'" />
                        </td>
                        <td>
                            <div class="flex">
                                <button pButton pRipple icon="pi pi-pencil" class="mr-2" size="large" [rounded]="true" [text]="true" [raised]="true" severity="success" (click)="editUsuario(usuario)"></button>
                                <button pButton pRipple icon="pi pi-trash" size="large" [rounded]="true" [text]="true" [raised]="true" severity="danger" [swal]="alertaBorrar" (confirm)="inactivar(usuario)"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <p-dialog [(visible)]="productDialog" [style]="{width: '500px'}" header="Nuevo usuario" [modal]="true" class="p-fluid">
            <form [formGroup]="formUsuario" (ngSubmit)="crearUsuario()">
            
                <div class="field">
                    <label for="ci">Cédula de identidad</label>
                    <input formControlName="ci" type="text" pInputText id="ci" />
                    @if (formUsuario.get('ci')?.hasError('required') && formUsuario.get('ci')?.touched) {
                    <small> El campo cédula de identidad es requerido </small>
                    }
                    @if (formUsuario.get('ci')?.hasError('minlength') && formUsuario.get('ci')?.touched) {
                    <small> El campo cédula de identidad debe tener al menos 7 caracteres </small>
                    }
                </div>
            
                <div class="field">
                    <label for="nombres">Nombres</label>
                    <input formControlName="nombres" type="text" pInputText id="nombres" />
                    @if (formUsuario.get('nombres')?.hasError('required') && formUsuario.get('nombres')?.touched) {
                    <small> El campo nombres es requerido </small>
                    }
                    @if (formUsuario.get('nombres')?.hasError('minlength') && formUsuario.get('nombres')?.touched) {
                    <small> El campo nombres debe tener al menos 3 caracteres </small>
                    }
                </div>
            
                <div class="field">
                    <label for="apellidos">Apellidos</label>
                    <input formControlName="apellidos" type="text" pInputText id="apellidos" />
                    @if (formUsuario.get('apellidos')?.hasError('required') && formUsuario.get('apellidos')?.touched) {
                    <small> El campo apellidos es requerido </small>
                    }
                    @if (formUsuario.get('apellidos')?.hasError('minlength') && formUsuario.get('apellidos')?.touched) {
                    <small> El campo apellidos debe tener al menos 3 caracteres </small>
                    }
                </div>
            
                <div class="field">
                    <label for="email">Email</label>
                    <input formControlName="email" type="text" pInputText id="email" />
                    @if (formUsuario.get('email')?.hasError('required') && formUsuario.get('email')?.touched) {
                    <small> El campo email es requerido </small>
                    }
                    @if (formUsuario.get('email')?.hasError('email') && formUsuario.get('email')?.touched) {
                    <small> El campo debe ser un email válido </small>
                    }
                </div>
            
                <div class="field" [ngStyle]="{'display': !editting ? 'block' : 'none'}">
                    <label for="password">Contraseña</label>
                    <p-password formControlName="password"
                        promptLabel="Elige una contraseña"
                        weakLabel="Muy simple"
                        mediumLabel="Moderada"
                        strongLabel="Segura"
                        [toggleMask]="true" inputId="password" />
                    @if (formUsuario.get('password')?.hasError('required') && formUsuario.get('password')?.touched) {
                    <small> El campo constraseña es requerido </small>
                    }
                    @if (formUsuario.get('password')?.hasError('minlength') && formUsuario.get('password')?.touched) {
                    <small> El campo constraseña debe tener al menos 8 caracteres </small>
                    }
                </div>
            
                <div class="field">
                    <label for="id_rol">Rol</label>
                    <p-dropdown formControlName="id_rol" inputId="id_rol" [options]="listaRolesDropdown" optionLabel="name"
                        placeholder="Seleccione un rol" [appendTo]="'body'" />
                    @if (formUsuario.get('id_rol')?.hasError('required') && formUsuario.get('id_rol')?.touched) {
                    <small> El campo rol es requerido </small>
                    }
                </div>
            
                <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text" type="button"
                    (click)="hideDialog()"></button>
                <button pButton pRipple label="Guardar" icon="pi pi-check" class="p-button-text" type="submit"></button>
            
            </form>
        </p-dialog>

    </div>
</div>
